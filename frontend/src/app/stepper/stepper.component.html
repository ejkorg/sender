
<div class="rounded-3xl bg-surface-95 p-8 shadow-2xl ring-1 ring-onsemi-primary/10">
  <div class="flex flex-col gap-8">
    <nav class="nav-tabs flex flex-wrap gap-3" role="tablist">
      <button type="button" class="nav-tab" role="tab" [attr.aria-selected]="stepIndex===0" [class.nav-tab--active]="stepIndex===0" (click)="goToStep(0)">1. Choose filters</button>
      <button type="button" class="nav-tab" role="tab" [attr.aria-selected]="stepIndex===1" [class.nav-tab--active]="stepIndex===1" (click)="goToStep(1)" [disabled]="!previewLoaded">2. Select payloads</button>
      <button type="button" class="nav-tab" role="tab" [attr.aria-selected]="stepIndex===2" [class.nav-tab--active]="stepIndex===2" (click)="goToStep(2)" [disabled]="!stageResponse && !stageStatus.length">3. Monitor staging</button>
    </nav>

    <!-- Duplicate prompt shown via ModalService.openComponent -->

    <div [ngSwitch]="stepIndex">
      <div *ngSwitchCase="0" class="space-y-8">
        <div class="grid gap-6 md:grid-cols-2">
          <div class="flex flex-col gap-2">
            <label class="text-sm font-semibold text-onsemi-charcoal" for="site">Site / DTP instance</label>
            <select id="site" [(ngModel)]="selectedSite" name="site" (ngModelChange)="onSiteChange()"
                    class="rounded-xl border border-slate-300 bg-surface px-4 py-3 text-sm shadow-sm focus:border-onsemi-primary focus:outline-none focus:ring-2 focus:ring-onsemi-primary/40">
              <option [ngValue]="null">Select site/dtp instance</option>
              <option *ngFor="let s of sites" [ngValue]="s">{{ s }}</option>
            </select>
            <p class="text-xs text-slate-500" *ngIf="selectedSite && !senderOptions.length && !sendersLoading">No senders available for this connection.</p>
          </div>

          <div class="flex flex-col gap-2"></div>
        </div>

        <!-- Lot / Wafer pairs placeholder: will be rendered after Test phase -->

        <div class="rounded-2xl border border-onsemi-primary/15 bg-onsemi-ice/60 px-4 py-3 text-sm text-onsemi-charcoal" *ngIf="filtersLoading">
          <div class="flex items-center gap-3">
            <span class="h-4 w-4 animate-spin rounded-full border-2 border-onsemi-primary border-t-transparent"></span>
            Loading connection filters…
          </div>
        </div>

        <!-- Lot / Wafer pairs removed from here and reinserted below Test phase -->

        <ng-container *ngIf="!filtersLoading && filterOptions as filters">
          <div class="grid gap-6 md:grid-cols-2">
            <div class="flex flex-col gap-2">
              <label class="text-sm font-semibold text-onsemi-charcoal" for="location">Location</label>
              <select id="location" [(ngModel)]="selectedLocation" name="location" (ngModelChange)="onLocationChanged()"
                      class="rounded-xl border border-slate-300 bg-surface px-4 py-3 text-sm shadow-sm focus:border-onsemi-primary focus:outline-none focus:ring-2 focus:ring-onsemi-primary/40">
                <option value="">Select location</option>
                <option *ngFor="let loc of filters.locations" [value]="loc">{{ loc }}</option>
              </select>
            </div>

            <div class="flex flex-col gap-2">
              <label class="text-sm font-semibold text-onsemi-charcoal" for="dataType">Data type</label>
              <select id="dataType" [(ngModel)]="selectedDataType" name="dataType" (ngModelChange)="onDataTypeChanged()"
                      class="rounded-xl border border-slate-300 bg-surface px-4 py-3 text-sm shadow-sm focus:border-onsemi-primary focus:outline-none focus:ring-2 focus:ring-onsemi-primary/40">
                <option value="">Select data type</option>
                <option *ngFor="let dt of filters.dataTypes" [value]="dt">{{ dt }}</option>
              </select>
            </div>
          </div>

          <div class="grid gap-6 md:grid-cols-2">
            <div class="flex flex-col gap-2">
              <label class="text-sm font-semibold text-onsemi-charcoal" for="testerType">Tester type</label>
              <select id="testerType" [(ngModel)]="selectedTesterType" name="testerType" (ngModelChange)="onTesterTypeChanged()"
                      class="rounded-xl border border-slate-300 bg-white px-4 py-3 text-sm shadow-sm focus:border-onsemi-primary focus:outline-none focus:ring-2 focus:ring-onsemi-primary/40">
                <option value="">Select tester type</option>
                <option *ngFor="let tt of filters.testerTypes" [value]="tt">{{ tt }}</option>
              </select>
            </div>

            <div class="flex flex-col gap-2">
              <label class="text-sm font-semibold text-onsemi-charcoal" for="sender">Sender</label>
              <ng-container *ngIf="senderAutoResolved && selectedSenderId; else senderDropdown">
                <div class="rounded-xl border border-slate-200 bg-slate-50 px-3 py-2 text-sm text-slate-700">Auto-selected: {{ selectedSenderId }} — {{ getSelectedSenderName() }}</div>
              </ng-container>
              <ng-template #senderDropdown>
                <select id="sender" [(ngModel)]="selectedSenderId" name="senderId" (ngModelChange)="onSenderChanged()"
                        [disabled]="sendersLoading || !senderOptions.length"
                        class="rounded-xl border border-slate-300 bg-white px-4 py-3 text-sm shadow-sm focus:border-onsemi-primary focus:outline-none focus:ring-2 focus:ring-onsemi-primary/40 disabled:cursor-not-allowed disabled:opacity-60">
                  <option [ngValue]="null">Select sender</option>
                  <option *ngFor="let sender of senderOptions" [ngValue]="sender.idSender">{{ sender.idSender }} — {{ sender.name }}</option>
                </select>
                <p class="flex items-center gap-2 text-xs text-slate-500" *ngIf="sendersLoading">
                  <span class="h-3 w-3 animate-spin rounded-full border border-onsemi-primary border-t-transparent"></span>
                  Loading sender list…
                </p>
              </ng-template>
            </div>
          </div>
        </ng-container>

        <div class="grid gap-6 md:grid-cols-2">
          <div class="flex flex-col gap-2">
            <label class="text-sm font-semibold text-onsemi-charcoal" for="phase">Test phase</label>
            <select id="phase" [(ngModel)]="selectedTestPhase" name="testPhase"
                    [disabled]="!testPhaseOptions.length && !testPhaseLoading"
                    class="rounded-xl border border-slate-300 bg-white px-4 py-3 text-sm shadow-sm focus:border-onsemi-primary focus:outline-none focus:ring-2 focus:ring-onsemi-primary/40 disabled:cursor-not-allowed disabled:bg-slate-100 disabled:text-slate-400">
              <option value="">Any</option>
              <option *ngFor="let phase of testPhaseOptions" [value]="phase">{{ phase || 'None' }}</option>
            </select>
            <p class="flex items-center gap-2 text-xs text-slate-500" *ngIf="testPhaseLoading">
              <span class="h-3 w-3 animate-spin rounded-full border border-onsemi-primary border-t-transparent"></span>
              Loading phases…
            </p>
          </div>
          <div class="grid gap-4 rounded-2xl border border-slate-200 bg-slate-50 p-4 md:grid-cols-2">
            <ng-container *ngIf="isAdmin; else nonAdminDates">
                   <div class="flex flex-col gap-2">
                  <label class="text-sm font-semibold text-onsemi-charcoal" for="startDate">Start (date & time)</label>
                  <!-- datetime-local provides local date/time; bind to ISO-local value -->
                  <input id="startDate" type="datetime-local" [ngModel]="startDate ? (startDate | date:'yyyy-MM-ddTHH:mm') : ''" (ngModelChange)="onStartDateChange($event)" name="startDate"
                    class="rounded-xl border border-slate-300 bg-surface px-4 py-3 text-sm shadow-sm focus:border-onsemi-primary focus:outline-none focus:ring-2 focus:ring-onsemi-primary/40">
                </div>
                <div class="flex flex-col gap-2">
                  <label class="text-sm font-semibold text-onsemi-charcoal" for="endDate">End (date & time)</label>
                  <input id="endDate" type="datetime-local" [ngModel]="endDate ? (endDate | date:'yyyy-MM-ddTHH:mm') : ''" (ngModelChange)="onEndDateChange($event)" name="endDate"
                    class="rounded-xl border border-slate-300 bg-surface px-4 py-3 text-sm shadow-sm focus:border-onsemi-primary focus:outline-none focus:ring-2 focus:ring-onsemi-primary/40">
                </div>
            </ng-container>
            <ng-template #nonAdminDates>
              <div class="col-span-2 text-sm text-slate-600">Non-admin users search by lot/wafer pairs only.</div>
            </ng-template>
          </div>
        </div>

        <!-- Lot / Wafer pairs: appear immediately after the Test phase (and before the Selected connection summary) -->
        <div class="mt-4" *ngIf="selectedSite && selectedLocation && selectedDataType && (selectedTesterType || !(filterOptions?.testerTypes?.length))">
          <label class="text-sm font-semibold text-onsemi-charcoal">Lot / Wafer pairs</label>
          <p class="text-xs text-slate-500">Wafer is optional — leave blank to match any wafer for the given lot.</p>
          <div class="space-y-2 mt-2">
            <div *ngFor="let pair of lotWaferPairs; let i = index" class="grid gap-2 grid-cols-1 sm:grid-cols-2 md:grid-cols-3 items-center">
              <div>
                <input [(ngModel)]="pair.lot" name="lot{{i}}" placeholder="Lot" class="rounded-xl border border-slate-300 bg-surface px-4 py-3 text-sm shadow-sm" />
                <div *ngIf="!pair.lot && pair.wafer" class="text-amber-600 text-xs mt-1">Wafer provided without lot — this will be treated as a wafer-only match.</div>
              </div>
              <div>
                <input [(ngModel)]="pair.wafer" name="wafer{{i}}" placeholder="Wafer (optional)" class="rounded-xl border border-slate-300 bg-surface px-4 py-3 text-sm shadow-sm" />
              </div>
              <div class="flex items-center">
                <button type="button" class="btn-secondary mr-2" (click)="removeLotWaferPair(i)" [disabled]="lotWaferPairs.length <= 1">Remove</button>
                <span class="text-xs text-slate-500">{{ i + 1 }}</span>
              </div>
            </div>
            <div>
              <button type="button" class="btn-secondary" (click)="addLotWaferPair()" [disabled]="lotWaferPairs.length >= maxLotWaferPairs || !isLastPairFilled()">+ Add another pair</button>
            </div>
          </div>
        </div>

        <div class="flex flex-col gap-3 rounded-2xl border border-slate-200 bg-slate-50 p-4 text-sm text-slate-600">
          <p><strong>Selected connection:</strong> {{ selectedSite || 'None' }}</p>
          <p *ngIf="selectedSenderId"><strong>Sender:</strong> {{ selectedSenderId }} — {{ getSelectedSenderName() }}</p>
          <p *ngIf="selectedLocation"><strong>Location:</strong> {{ selectedLocation }}</p>
          <p *ngIf="selectedDataType"><strong>Data type:</strong> {{ selectedDataType }}</p>
        </div>

        <!-- Lot / Wafer pairs removed from here (moved up after Test phase) -->

        <div class="flex flex-col gap-3 sm:flex-row sm:items-center sm:justify-between">
          <p class="text-sm text-slate-600" *ngIf="!canSearch()">Select site, location, data type, tester, and sender to continue. Non-admins must provide at least one lot/wafer pair.</p>
          <button type="button" class="btn-primary w-full py-3 sm:w-auto" (click)="doPreview(0)" [disabled]="loading || !canSearch()">
            <ng-container *ngIf="!loading; else previewLoadingTpl">Preview</ng-container>
          </button>
          <ng-template #previewLoadingTpl>
            <div class="flex items-center justify-center gap-2">
              <span class="h-4 w-4 animate-spin rounded-full border-2 border-white border-t-transparent"></span>
              Previewing…
            </div>
          </ng-template>
        </div>
      </div>

      <div *ngSwitchCase="1" class="space-y-6">
        <ng-container *ngIf="previewLoaded; else noPreviewState">
          <div class="flex flex-col gap-3 rounded-2xl border border-slate-200 bg-slate-50 p-4 md:flex-row md:items-center md:justify-between">
            <div>
              <p class="text-sm font-semibold text-onsemi-charcoal">{{ previewTotal }} result{{ previewTotal === 1 ? '' : 's' }}</p>
              <p class="text-xs text-slate-600">{{ selectedCount }} selected</p>
            </div>
            <div class="flex flex-wrap gap-2">
              <button type="button" class="btn-secondary" (click)="toggleSelectAllCurrentPage(true)" [disabled]="previewLoading || !previewRows.length">Select page</button>
              <button type="button" class="btn-secondary" (click)="toggleSelectAllCurrentPage(false)" [disabled]="previewLoading || !previewRows.length">Clear page</button>
              <button type="button" class="btn-secondary" (click)="exportPreviewCsv(false)" [disabled]="!previewRows.length">Export page</button>
              <button type="button" class="btn-secondary" (click)="exportPreviewCsv(true)" [disabled]="!selectedCount">Export selected</button>
              <button type="button" class="btn-secondary" (click)="copyPreviewSql()" [disabled]="!previewDebugSql">Copy SQL</button>
            </div>
          </div>

          <div class="relative overflow-hidden rounded-2xl border border-slate-200">
            <div *ngIf="previewLoading" class="absolute inset-0 z-10 flex items-center justify-center bg-surface-70">
              <span class="h-6 w-6 animate-spin rounded-full border-2 border-onsemi-primary border-t-transparent"></span>
            </div>
            <div class="overflow-auto">
              <table class="min-w-full divide-y divide-slate-200 text-sm">
                <thead class="bg-onsemi-ice text-onsemi-charcoal">
                  <tr>
                    <th class="px-4 py-3 text-left font-semibold">Metadata ID</th>
                    <th class="px-4 py-3 text-left font-semibold">Data ID</th>
                     <th class="px-4 py-3 text-left font-semibold">Lot</th>
                     <th class="px-4 py-3 text-left font-semibold">Wafer</th>
                     <th class="px-4 py-3 text-left font-semibold">File</th>
                     <th class="px-4 py-3 text-left font-semibold">End Time</th>
                    <th class="px-4 py-3 text-left font-semibold">Duplicate</th>
                    <th class="px-4 py-3 text-center font-semibold">Select</th>
                    <th class="px-4 py-3 text-center font-semibold">Actions</th>
                  </tr>
                </thead>
                <tbody class="divide-y divide-slate-100 bg-surface">
                  <tr *ngFor="let row of previewRows" class="hover:bg-onsemi-ice/60">
                    <td class="px-4 py-3 font-medium text-onsemi-charcoal">{{ row.metadataId || '—' }}</td>
                    <td class="px-4 py-3 text-slate-700">{{ row.dataId || '—' }}</td>
                     <td class="px-4 py-3 text-slate-700">{{ row.lot || '—' }}</td>
                     <td class="px-4 py-3 text-slate-700">
                       <span *ngIf="row.wafer">{{ row.wafer }}</span>
                     </td>
                     <td class="px-4 py-3 text-slate-700" title="{{ row.originalFileName || '' }}">{{ row.originalFileName ? (row.originalFileName | truncate:36) : '—' }}</td>
                     <td class="px-4 py-3 text-slate-600 whitespace-nowrap">{{ row.endTime ? (row.endTime | date: uiDateFormat) : '—' }}</td>
                    <td class="px-4 py-3 text-slate-700">
                      <ng-container *ngIf="previewDuplicateForRow(row) as dup">
                        <div class="text-amber-800 font-semibold">DUPLICATE<span class="ml-2 text-xs text-slate-500">{{ dup.previousStatus ? '(' + dup.previousStatus + ')' : '' }}</span></div>
                        <div class="text-xs text-slate-500">
                          <div *ngIf="row.dataId" class="text-xs text-slate-500">Data ID: {{ row.dataId }}</div>
                          <span *ngIf="dup.stagedBy">staged by {{ dup.stagedBy }}</span>
                          <span *ngIf="dup.lastRequestedBy"><span *ngIf="dup.stagedBy"> · </span>last requested by {{ dup.lastRequestedBy }}</span>
                          <div *ngIf="dup.stagedAt || dup.lastRequestedAt" class="text-xs text-slate-400">
                            {{ dup.stagedAt ? (dup.stagedAt | date: uiDateFormat) : (dup.lastRequestedAt ? (dup.lastRequestedAt | date: uiDateFormat) : '') }}
                          </div>
                        </div>
                      </ng-container>
                      <ng-container *ngIf="!previewDuplicateForRow(row)">—</ng-container>
                    </td>
                    <td class="px-4 py-3 text-center">
                      <input type="checkbox" class="h-4 w-4 rounded border-slate-300 text-onsemi-primary focus:ring-onsemi-primary/40"
                             [checked]="isRowSelected(row)" (change)="toggleRow(row, $event.target.checked)" />
                    </td>
                    <td class="px-4 py-3 text-center">
                      <div class="flex items-center justify-center gap-2">
                        <button type="button" class="btn-secondary" (click)="openDuplicateDetails(row)" [disabled]="!previewDuplicateForRow(row)">Details</button>
                        <button type="button" class="btn-secondary" (click)="skipPreviewRow(row)">Skip</button>
                        <button type="button" class="btn-primary" (click)="stageSingleForce(row)" [disabled]="staging">Force</button>
                      </div>
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
            <p class="px-4 py-3 text-sm text-slate-500" *ngIf="!previewRows.length && !previewLoading">No results on this page.</p>
          </div>

          <div class="flex flex-col gap-3 rounded-2xl border border-slate-200 bg-slate-50 p-4 text-sm md:flex-row md:items-center md:justify-between">
            <div class="flex items-center gap-3">
              <button type="button" class="btn-secondary" (click)="changePreviewPage(-1)" [disabled]="previewLoading || previewPage === 0">Prev</button>
              <span>Page {{ previewPage + 1 }} of {{ previewLastPage + 1 }}</span>
              <button type="button" class="btn-secondary" (click)="changePreviewPage(1)" [disabled]="previewLoading || previewLastPage < 0 || previewPage >= previewLastPage">Next</button>
            </div>
            <div class="flex items-center gap-3">
              <label for="previewSize" class="text-sm text-slate-600">Page size</label>
              <select id="previewSize" [(ngModel)]="previewSize" name="previewSize" (ngModelChange)="changePreviewSize($event)"
                      class="rounded-lg border border-slate-300 bg-surface px-3 py-2 text-sm shadow-sm focus:border-onsemi-primary focus:outline-none focus:ring-2 focus:ring-onsemi-primary/40">
                <option *ngFor="let size of previewSizes" [value]="size">{{ size }}</option>
              </select>
            </div>
          </div>

          <label class="flex items-center gap-2 text-sm text-slate-600">
            <input type="checkbox" class="h-4 w-4 rounded border-slate-300 text-onsemi-primary focus:ring-onsemi-primary/40" [(ngModel)]="triggerDispatch" name="triggerDispatch" />
            Dispatch immediately after staging
          </label>

          <div class="flex flex-col gap-3 sm:flex-row sm:items-center sm:justify-between">
            <button type="button" class="btn-secondary" (click)="goToStep(0)">Back</button>
            <p class="text-sm text-slate-600">{{ selectedCount }} selected</p>
            <button type="button" class="btn-primary" (click)="stageSelected()" [disabled]="staging || selectedCount === 0">
              <ng-container *ngIf="!staging; else stagingTpl">Stage selected</ng-container>
            </button>
            <ng-template #stagingTpl>
              <div class="flex items-center justify-center gap-2">
                <span class="h-4 w-4 animate-spin rounded-full border-2 border-white border-t-transparent"></span>
                Staging…
              </div>
            </ng-template>
          </div>
        </ng-container>
        <ng-template #noPreviewState>
          <div class="rounded-2xl border border-dashed border-slate-300 bg-slate-50 p-6 text-center text-sm text-slate-600">
            Preview results appear here after step 1.
          </div>
        </ng-template>
      </div>

      <div *ngSwitchCase="2" class="space-y-6">
        <div class="flex flex-col gap-3 sm:flex-row sm:items-center sm:justify-between">
          <button type="button" class="btn-secondary" (click)="reset()">Start over</button>
          <button type="button" class="btn-primary" (click)="refreshMonitoring()" [disabled]="statusLoading || stageRecordsLoading">
            <ng-container *ngIf="!(statusLoading || stageRecordsLoading); else refreshingTpl">Refresh metrics</ng-container>
          </button>
          <ng-template #refreshingTpl>
            <div class="flex items-center justify-center gap-2">
              <span class="h-4 w-4 animate-spin rounded-full border-2 border-white border-t-transparent"></span>
              Refreshing…
            </div>
          </ng-template>
        </div>

        <div *ngIf="stageResponse" class="space-y-4 rounded-2xl border border-onsemi-primary/20 bg-onsemi-ice/60 p-5">
          <div class="flex flex-wrap gap-6 text-sm text-onsemi-charcoal">
            <p><strong>Staged:</strong> {{ stageResponse.staged }}</p>
            <p><strong>Duplicates:</strong> {{ stageResponse.duplicates }}</p>
            <p><strong>Dispatched:</strong> {{ stageResponse.dispatched }}</p>
          </div>
          <div class="rounded-xl border border-amber-300 bg-amber-50 px-4 py-3 text-sm text-amber-700" *ngIf="stageResponse.requiresConfirmation">
            Dispatch pending confirmation. Re-run staging to proceed.
          </div>
          <!-- Duplicate display mode toggle -->
          <div class="flex items-center gap-3">
            <label class="text-sm text-slate-600">Duplicate view:</label>
            <div class="flex gap-2">
              <button type="button" class="btn-secondary" [class.btn-primary]="duplicateDisplayMode==='group'" (click)="setDuplicateDisplayMode('group')">Grouped</button>
              <button type="button" class="btn-secondary" [class.btn-primary]="duplicateDisplayMode==='interleave'" (click)="setDuplicateDisplayMode('interleave')">Interleaved</button>
            </div>
            <p class="text-xs text-slate-500 ml-4">Grouped = compact; Interleaved = chronological with staged records.</p>
          </div>

        <div *ngIf="stageStatus.length" class="grid gap-4 md:grid-cols-2 xl:grid-cols-3">
          <div *ngFor="let status of stageStatus" class="rounded-2xl border border-slate-200 bg-surface p-5 shadow-sm">
            <h3 class="text-sm font-semibold text-onsemi-charcoal">Sender {{ status.senderId }}</h3>
            <dl class="mt-3 space-y-2 text-sm text-slate-600">
              <div class="flex justify-between"><dt>Total</dt><dd class="font-semibold text-onsemi-charcoal">{{ status.total }}</dd></div>
              <div class="flex justify-between"><dt>Ready</dt><dd class="font-semibold text-onsemi-charcoal">{{ status.ready }}</dd></div>
              <div class="flex justify-between"><dt>Enqueued</dt><dd class="font-semibold text-onsemi-charcoal">{{ status.enqueued }}</dd></div>
              <div class="flex justify-between"><dt>Completed</dt><dd class="font-semibold text-onsemi-charcoal">{{ status.completed }}</dd></div>
              <div class="flex justify-between"><dt>Failed</dt><dd class="font-semibold text-onsemi-charcoal">{{ status.failed }}</dd></div>
            </dl>
            <div class="mt-4 space-y-2" *ngIf="status.users.length">
              <p class="text-xs font-semibold uppercase tracking-wide text-slate-500">User breakdown</p>
              <div class="space-y-2 text-xs text-slate-600">
                <div *ngFor="let user of status.users" class="rounded-xl border border-slate-200 bg-slate-50 p-3">
                  <div class="flex items-center justify-between">
                    <span class="font-semibold text-onsemi-charcoal">{{ user.username || 'unknown' }}</span>
                    <span class="text-slate-500">{{ user.lastRequestedAt ? (user.lastRequestedAt | date: uiDateFormat) : '—' }}</span>
                  </div>
                  <!-- Lot/Wafer inputs removed from user breakdown (kept in Step 1 canonical location) -->
                  <div class="flex items-center gap-3">
                    <label for="stageRecordsSize" class="text-sm text-slate-600">Page size</label>
                    <select id="stageRecordsSize" [(ngModel)]="stageRecordsSize" name="stageRecordsSize" (ngModelChange)="changeStageRecordsSize($event)"
                            class="rounded-lg border border-slate-300 bg-white px-3 py-2 text-sm shadow-sm focus:border-onsemi-primary focus:outline-none focus:ring-2 focus:ring-onsemi-primary/40">
                      <option *ngFor="let size of stageRecordsSizes" [value]="size">{{ size }}</option>
                    </select>
                  </div>
                  </div>
                </div>
              </div>
            </div>

          <div class="flex items-center justify-end gap-2 md:ml-auto">
            <label for="stageRecordsSize" class="text-sm text-slate-600 mr-3 hidden md:inline">Page size</label>
            <select id="stageRecordsSize" [(ngModel)]="stageRecordsSize" name="stageRecordsSize" (ngModelChange)="changeStageRecordsSize($event)"
                    class="rounded-lg border border-slate-300 bg-white px-3 py-2 text-sm shadow-sm focus:border-onsemi-primary focus:outline-none focus:ring-2 focus:ring-onsemi-primary/40 md:inline">
              <option *ngFor="let size of stageRecordsSizes" [value]="size">{{ size }}</option>
            </select>

            <button type="button" class="btn-secondary" (click)="exportStageRecordsCsv()" [disabled]="!stageRecords.length">Export CSV</button>
          </div>
        </div>

        <div class="relative overflow-hidden rounded-2xl border border-slate-200">
            <div *ngIf="stageRecordsLoading" class="absolute inset-0 z-10 flex items-center justify-center bg-surface-70">
            <span class="h-6 w-6 animate-spin rounded-full border-2 border-onsemi-primary border-t-transparent"></span>
          </div>
          <div class="overflow-auto">
            <table class="min-w-full divide-y divide-slate-200 text-sm">
              <thead class="bg-onsemi-ice text-onsemi-charcoal">
                <tr>
                  <th class="px-4 py-3 text-left font-semibold">Metadata ID</th>
                  <th class="px-4 py-3 text-left font-semibold">Data ID</th>
                  <th class="px-4 py-3 text-left font-semibold">Status</th>
                  <th class="px-4 py-3 text-left font-semibold">Staged By</th>
                  <th class="px-4 py-3 text-left font-semibold">Last Requested</th>
                  <th class="px-4 py-3 text-left font-semibold">Updated</th>
                  <th class="px-4 py-3 text-left font-semibold">Error</th>
                </tr>
              </thead>
              <tbody class="divide-y divide-slate-100 bg-surface">
                <ng-container *ngIf="duplicateDisplayMode === 'group'">
                  <tr *ngFor="let record of stageRecords" class="hover:bg-onsemi-ice/60">
                    <td class="px-4 py-3 font-medium text-onsemi-charcoal">
                      {{ record.metadataId || '—' }}
                      <div *ngIf="record.wafer" class="text-xs text-slate-500">Wafer: {{ record.wafer }}</div>
                    </td>
                    <td class="px-4 py-3 text-slate-700">
                      {{ record.dataId || '—' }}
                    </td>
                    <td class="px-4 py-3 text-slate-700">{{ record.status }}</td>
                    <td class="px-4 py-3 text-slate-700">{{ record.lastRequestedBy || record.stagedBy || 'unknown' }}</td>
                    <td class="px-4 py-3 text-slate-600">{{ record.lastRequestedAt ? (record.lastRequestedAt | date: uiDateFormat) : '—' }}</td>
                    <td class="px-4 py-3 text-slate-600">{{ record.updatedAt | date: uiDateFormat }}</td>
                    <td class="px-4 py-3 text-slate-600">{{ record.errorMessage || '—' }}</td>
                  </tr>
                  <tr *ngIf="visibleDuplicatePayloads?.length" class="bg-amber-50">
                    <td class="px-4 py-2 text-sm text-amber-800 font-medium" colspan="7">Duplicate payloads (already staged) — shown below with the user who staged them before</td>
                  </tr>
                  <tr *ngFor="let dup of visibleDuplicatePayloads" class="hover:bg-amber-100">
                    <td class="px-4 py-3 font-medium text-onsemi-charcoal">
                      {{ dup.metadataId || '—' }}
                      <div *ngIf="dup.wafer" class="text-xs text-amber-700">Wafer: {{ dup.wafer }}</div>
                    </td>
                    <td class="px-4 py-3 text-slate-700">{{ dup.dataId || '—' }}</td>
                    <td class="px-4 py-3 text-amber-800">DUPLICATE<span class="ml-2 text-xs text-slate-500">{{ dup.previousStatus ? '(' + dup.previousStatus + ')' : '' }}</span></td>
                    <td class="px-4 py-3 text-slate-700">{{ dup.lastRequestedBy || dup.stagedBy || 'unknown' }}</td>
                    <td class="px-4 py-3 text-slate-600">{{ dup.lastRequestedAt ? (dup.lastRequestedAt | date: uiDateFormat) : '—' }}</td>
                    <td class="px-4 py-3 text-slate-600">—</td>
                    <td class="px-4 py-3 text-slate-600">—</td>
                  </tr>
                </ng-container>
                <ng-container *ngIf="duplicateDisplayMode === 'interleave'">
                  <tr *ngFor="let row of mergedStageAndDuplicateRows" [ngClass]="{'hover:bg-amber-100': row.__type === 'dup'}">
                    <td class="px-4 py-3 font-medium text-onsemi-charcoal">
                      {{ row.item.metadataId || '—' }}
                      <div *ngIf="row.item.wafer" class="text-xs text-slate-500">Wafer: {{ row.item.wafer }}</div>
                    </td>
                    <td class="px-4 py-3 text-slate-700">
                      {{ row.item.dataId || '—' }}
                    </td>
                    <td [ngClass]="row.__type === 'dup' ? 'text-amber-800' : 'text-slate-700'" class="px-4 py-3"> 
                      <ng-container *ngIf="row.__type === 'dup'">DUPLICATE<span class="ml-2 text-xs text-slate-500">{{ row.item.previousStatus ? '(' + row.item.previousStatus + ')' : '' }}</span></ng-container>
                      <ng-container *ngIf="row.__type === 'record'">{{ row.item.status }}</ng-container>
                    </td>
                    <td class="px-4 py-3 text-slate-700">{{ row.__type === 'record' ? (row.item.lastRequestedBy || row.item.stagedBy || 'unknown') : (row.item.lastRequestedBy || row.item.stagedBy || 'unknown') }}</td>
                    <td class="px-4 py-3 text-slate-600">{{ row.__type === 'record' ? (row.item.lastRequestedAt ? (row.item.lastRequestedAt | date: uiDateFormat) : '—') : (row.item.lastRequestedAt ? (row.item.lastRequestedAt | date: uiDateFormat) : '—') }}</td>
                    <td class="px-4 py-3 text-slate-600">{{ row.__type === 'record' ? (row.item.updatedAt | date: uiDateFormat) : '—' }}</td>
                    <td class="px-4 py-3 text-slate-600">{{ row.__type === 'record' ? (row.item.errorMessage || '—') : '—' }}</td>
                  </tr>
                </ng-container>
              </tbody>
            </table>
          </div>
          <p class="px-4 py-3 text-sm text-slate-500" *ngIf="!stageRecords.length && !stageRecordsLoading">No staged records for this filter.</p>
        </div>

        <div class="flex items-center justify-between rounded-2xl border border-slate-200 bg-slate-50 p-4 text-sm text-slate-600" *ngIf="stageRecordsTotal > 0">
          <button type="button" class="btn-secondary" (click)="changeStageRecordsPage(-1)" [disabled]="stageRecordsLoading || stageRecordsPage === 0">Prev</button>
          <span>Page {{ stageRecordsPage + 1 }} of {{ stageRecordsLastPage + 1 }}</span>
          <button type="button" class="btn-secondary" (click)="changeStageRecordsPage(1)" [disabled]="stageRecordsLoading || stageRecordsLastPage < 0 || stageRecordsPage >= stageRecordsLastPage">Next</button>
        </div>
      </div>
    </div>
  </div>
</div>
