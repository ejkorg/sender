<section class="rounded-3xl bg-white/95 p-8 shadow-2xl ring-1 ring-onsemi-primary/10">
  <div class="flex flex-col gap-8">
    <nav class="flex flex-wrap gap-3">
      <button type="button"
              class="rounded-2xl px-5 py-2 text-sm font-semibold transition focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2"
              [class.bg-onsemi-primary]="stepIndex === 0"
              [class.text-white]="stepIndex === 0"
              [class.bg-onsemi-ice]="stepIndex !== 0"
              [class.text-onsemi-charcoal]="stepIndex !== 0"
              (click)="goToStep(0)">
        1. Choose filters
      </button>
      <button type="button"
              class="rounded-2xl px-5 py-2 text-sm font-semibold transition focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2"
              [class.bg-onsemi-primary]="stepIndex === 1"
              [class.text-white]="stepIndex === 1"
              [class.bg-onsemi-ice]="stepIndex !== 1"
              [class.text-onsemi-charcoal]="stepIndex !== 1"
              (click)="goToStep(1)"
              [disabled]="!previewLoaded">
        2. Select payloads
      </button>
      <button type="button"
              class="rounded-2xl px-5 py-2 text-sm font-semibold transition focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2"
              [class.bg-onsemi-primary]="stepIndex === 2"
              [class.text-white]="stepIndex === 2"
              [class.bg-onsemi-ice]="stepIndex !== 2"
              [class.text-onsemi-charcoal]="stepIndex !== 2"
              (click)="goToStep(2)"
              [disabled]="!stageResponse && !stageStatus.length">
        3. Monitor staging
      </button>
    </nav>

    <ng-container *ngIf="duplicatePrompt as prompt">
      <div class="fixed inset-0 z-40 flex items-center justify-center bg-slate-900/60 px-4">
        <div class="w-full max-w-2xl rounded-2xl bg-white p-8 shadow-2xl">
          <h2 class="text-lg font-semibold text-onsemi-charcoal">Duplicate payloads detected</h2>
          <p class="mt-2 text-sm text-slate-600">{{ prompt.response.duplicatePayloads.length || 0 }} payloads already exist. Continue to force staging?</p>
          <div class="mt-6 max-h-60 overflow-y-auto rounded-xl border border-slate-200 bg-slate-50 px-4 py-3" *ngIf="prompt.response.duplicatePayloads.length">
            <table class="w-full text-left text-xs">
              <thead class="sticky top-0 bg-slate-100 text-slate-600">
                <tr>
                  <th class="py-2">Metadata</th>
                  <th class="py-2">Data</th>
                  <th class="py-2">Requested By</th>
                  <th class="py-2">Last Requested</th>
                  <th class="py-2">Status</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let dup of prompt.response.duplicatePayloads" class="border-b border-slate-200/70">
                  <td class="py-2 font-semibold text-onsemi-charcoal">{{ dup.metadataId }}</td>
                  <td class="py-2 text-slate-700">{{ dup.dataId }}</td>
                  <td class="py-2 text-slate-700">{{ dup.lastRequestedBy || dup.stagedBy || 'unknown' }}</td>
                  <td class="py-2 text-slate-600">{{ dup.lastRequestedAt ? (dup.lastRequestedAt | date: uiDateFormat) : '—' }}</td>
                  <td class="py-2 text-slate-600">{{ dup.previousStatus || '—' }}</td>
                </tr>
              </tbody>
            </table>
          </div>
          <div class="mt-6 flex justify-end gap-3">
            <button type="button" class="btn-secondary" (click)="confirmDuplicate(false)">Cancel</button>
            <button type="button" class="btn-primary" (click)="confirmDuplicate(true)">Force staging</button>
          </div>
        </div>
      </div>
    </ng-container>

    <ng-container [ngSwitch]="stepIndex">
      <section *ngSwitchCase="0" class="space-y-8">
        <div class="grid gap-6 md:grid-cols-2">
          <div class="flex flex-col gap-2">
            <label class="text-sm font-semibold text-onsemi-charcoal" for="site">Site / Connection</label>
            <select id="site" [(ngModel)]="selectedSite" name="site" (ngModelChange)="onSiteChange()"
                    class="rounded-xl border border-slate-300 bg-white px-4 py-3 text-sm shadow-sm focus:border-onsemi-primary focus:outline-none focus:ring-2 focus:ring-onsemi-primary/40">
              <option [ngValue]="null">Select site</option>
              <option *ngFor="let s of sites" [ngValue]="s">{{ s }}</option>
            </select>
            <p class="text-xs text-slate-500" *ngIf="selectedSite && !senderOptions.length && !sendersLoading">No senders available for this connection.</p>
          </div>

          <div class="flex flex-col gap-2">
            <label class="text-sm font-semibold text-onsemi-charcoal" for="environment">Environment</label>
            <select id="environment" [(ngModel)]="selectedEnvironment" name="environment"
                    class="rounded-xl border border-slate-300 bg-white px-4 py-3 text-sm shadow-sm focus:border-onsemi-primary focus:outline-none focus:ring-2 focus:ring-onsemi-primary/40">
              <option value="qa">QA</option>
              <option value="prod">Production</option>
            </select>
          </div>
        </div>

        <div class="rounded-2xl border border-onsemi-primary/15 bg-onsemi-ice/60 px-4 py-3 text-sm text-onsemi-charcoal" *ngIf="filtersLoading">
          <div class="flex items-center gap-3">
            <span class="h-4 w-4 animate-spin rounded-full border-2 border-onsemi-primary border-t-transparent"></span>
            Loading connection filters…
          </div>
        </div>

        <ng-container *ngIf="!filtersLoading && filterOptions as filters">
          <div class="grid gap-6 md:grid-cols-2">
            <div class="flex flex-col gap-2">
              <label class="text-sm font-semibold text-onsemi-charcoal" for="location">Location</label>
              <select id="location" [(ngModel)]="selectedLocation" name="location" (ngModelChange)="onLocationChanged()"
                      class="rounded-xl border border-slate-300 bg-white px-4 py-3 text-sm shadow-sm focus:border-onsemi-primary focus:outline-none focus:ring-2 focus:ring-onsemi-primary/40">
                <option value="">Select location</option>
                <option *ngFor="let loc of filters.locations" [value]="loc">{{ loc }}</option>
              </select>
            </div>

            <div class="flex flex-col gap-2">
              <label class="text-sm font-semibold text-onsemi-charcoal" for="dataType">Data type</label>
              <select id="dataType" [(ngModel)]="selectedDataType" name="dataType" (ngModelChange)="onDataTypeChanged()"
                      class="rounded-xl border border-slate-300 bg-white px-4 py-3 text-sm shadow-sm focus:border-onsemi-primary focus:outline-none focus:ring-2 focus:ring-onsemi-primary/40">
                <option value="">Select data type</option>
                <option *ngFor="let dt of filters.dataTypes" [value]="dt">{{ dt }}</option>
              </select>
            </div>
          </div>

          <div class="grid gap-6 md:grid-cols-2">
            <div class="flex flex-col gap-2">
              <label class="text-sm font-semibold text-onsemi-charcoal" for="testerType">Tester type</label>
              <select id="testerType" [(ngModel)]="selectedTesterType" name="testerType" (ngModelChange)="onTesterTypeChanged()"
                      class="rounded-xl border border-slate-300 bg-white px-4 py-3 text-sm shadow-sm focus:border-onsemi-primary focus:outline-none focus:ring-2 focus:ring-onsemi-primary/40">
                <option value="">Select tester type</option>
                <option *ngFor="let tt of filters.testerTypes" [value]="tt">{{ tt }}</option>
              </select>
            </div>

            <div class="flex flex-col gap-2">
              <label class="text-sm font-semibold text-onsemi-charcoal" for="sender">Sender</label>
              <select id="sender" [(ngModel)]="selectedSenderId" name="senderId" (ngModelChange)="onSenderChanged()"
                      [disabled]="sendersLoading || !senderOptions.length"
                      class="rounded-xl border border-slate-300 bg-white px-4 py-3 text-sm shadow-sm focus:border-onsemi-primary focus:outline-none focus:ring-2 focus:ring-onsemi-primary/40 disabled:cursor-not-allowed disabled:opacity-60">
                <option [ngValue]="null">Select sender</option>
                <option *ngFor="let sender of senderOptions" [ngValue]="sender.idSender">{{ sender.idSender }} — {{ sender.name }}</option>
              </select>
              <p class="flex items-center gap-2 text-xs text-slate-500" *ngIf="sendersLoading">
                <span class="h-3 w-3 animate-spin rounded-full border border-onsemi-primary border-t-transparent"></span>
                Loading sender list…
              </p>
            </div>
          </div>
        </ng-container>

        <div class="grid gap-6 md:grid-cols-2">
          <div class="flex flex-col gap-2">
            <label class="text-sm font-semibold text-onsemi-charcoal" for="phase">Test phase</label>
            <select id="phase" [(ngModel)]="selectedTestPhase" name="testPhase"
                    [disabled]="!testPhaseOptions.length && !testPhaseLoading"
                    class="rounded-xl border border-slate-300 bg-white px-4 py-3 text-sm shadow-sm focus:border-onsemi-primary focus:outline-none focus:ring-2 focus:ring-onsemi-primary/40 disabled:cursor-not-allowed disabled:bg-slate-100 disabled:text-slate-400">
              <option value="">Any</option>
              <option *ngFor="let phase of testPhaseOptions" [value]="phase">{{ phase || 'None' }}</option>
            </select>
            <p class="flex items-center gap-2 text-xs text-slate-500" *ngIf="testPhaseLoading">
              <span class="h-3 w-3 animate-spin rounded-full border border-onsemi-primary border-t-transparent"></span>
              Loading phases…
            </p>
          </div>

          <div class="grid gap-4 rounded-2xl border border-slate-200 bg-slate-50 p-4 md:grid-cols-2">
            <div class="flex flex-col gap-2">
              <label class="text-sm font-semibold text-onsemi-charcoal" for="startDate">Start date</label>
              <input id="startDate" type="date" [ngModel]="startDate ? (startDate | date:'yyyy-MM-dd') : ''" (ngModelChange)="onStartDateChange($event)" name="startDate"
                     class="rounded-xl border border-slate-300 bg-white px-4 py-3 text-sm shadow-sm focus:border-onsemi-primary focus:outline-none focus:ring-2 focus:ring-onsemi-primary/40">
            </div>
            <div class="flex flex-col gap-2">
              <label class="text-sm font-semibold text-onsemi-charcoal" for="endDate">End date</label>
              <input id="endDate" type="date" [ngModel]="endDate ? (endDate | date:'yyyy-MM-dd') : ''" (ngModelChange)="onEndDateChange($event)" name="endDate"
                     class="rounded-xl border border-slate-300 bg-white px-4 py-3 text-sm shadow-sm focus:border-onsemi-primary focus:outline-none focus:ring-2 focus:ring-onsemi-primary/40">
            </div>
          </div>
        </div>

        <div class="flex flex-col gap-3 rounded-2xl border border-slate-200 bg-slate-50 p-4 text-sm text-slate-600">
          <p><strong>Selected connection:</strong> {{ selectedSite || 'None' }}</p>
          <p *ngIf="selectedSenderId"><strong>Sender:</strong> {{ selectedSenderId }}</p>
          <p *ngIf="selectedLocation"><strong>Location:</strong> {{ selectedLocation }}</p>
          <p *ngIf="selectedDataType"><strong>Data type:</strong> {{ selectedDataType }}</p>
        </div>

        <div class="flex flex-col gap-3 sm:flex-row sm:items-center sm:justify-between">
          <p class="text-sm text-slate-600" *ngIf="!canSearch()">Select site, location, data type, tester, and sender to continue.</p>
          <button type="button" class="btn-primary w-full py-3 sm:w-auto" (click)="doPreview(0)" [disabled]="loading || !canSearch()">
            <ng-container *ngIf="!loading; else previewLoadingTpl">Preview</ng-container>
          </button>
          <ng-template #previewLoadingTpl>
            <div class="flex items-center justify-center gap-2">
              <span class="h-4 w-4 animate-spin rounded-full border-2 border-white border-t-transparent"></span>
              Previewing…
            </div>
          </ng-template>
        </div>
      </section>

      <section *ngSwitchCase="1" class="space-y-6">
        <ng-container *ngIf="previewLoaded; else noPreviewState">
          <div class="flex flex-col gap-3 rounded-2xl border border-slate-200 bg-slate-50 p-4 md:flex-row md:items-center md:justify-between">
            <div>
              <p class="text-sm font-semibold text-onsemi-charcoal">{{ previewTotal }} result{{ previewTotal === 1 ? '' : 's' }}</p>
              <p class="text-xs text-slate-600">{{ selectedCount }} selected</p>
            </div>
            <div class="flex flex-wrap gap-2">
              <button type="button" class="btn-secondary" (click)="toggleSelectAllCurrentPage(true)" [disabled]="previewLoading || !previewRows.length">Select page</button>
              <button type="button" class="btn-secondary" (click)="toggleSelectAllCurrentPage(false)" [disabled]="previewLoading || !previewRows.length">Clear page</button>
              <button type="button" class="btn-secondary" (click)="exportPreviewCsv(false)" [disabled]="!previewRows.length">Export page</button>
              <button type="button" class="btn-secondary" (click)="exportPreviewCsv(true)" [disabled]="!selectedCount">Export selected</button>
              <button type="button" class="btn-secondary" (click)="copyPreviewSql()" [disabled]="!previewDebugSql">Copy SQL</button>
            </div>
          </div>

          <div class="relative overflow-hidden rounded-2xl border border-slate-200">
            <div *ngIf="previewLoading" class="absolute inset-0 z-10 flex items-center justify-center bg-white/70">
              <span class="h-6 w-6 animate-spin rounded-full border-2 border-onsemi-primary border-t-transparent"></span>
            </div>
            <div class="overflow-auto">
              <table class="min-w-full divide-y divide-slate-200 text-sm">
                <thead class="bg-onsemi-ice text-onsemi-charcoal">
                  <tr>
                    <th class="px-4 py-3 text-left font-semibold">Metadata ID</th>
                    <th class="px-4 py-3 text-left font-semibold">Data ID</th>
                    <th class="px-4 py-3 text-left font-semibold">Lot</th>
                    <th class="px-4 py-3 text-left font-semibold">End Time</th>
                    <th class="px-4 py-3 text-center font-semibold">Select</th>
                  </tr>
                </thead>
                <tbody class="divide-y divide-slate-100 bg-white">
                  <tr *ngFor="let row of previewRows" class="hover:bg-onsemi-ice/60">
                    <td class="px-4 py-3 font-medium text-onsemi-charcoal">{{ row.metadataId || '—' }}</td>
                    <td class="px-4 py-3 text-slate-700">{{ row.dataId || '—' }}</td>
                    <td class="px-4 py-3 text-slate-700">{{ row.lot || '—' }}</td>
                    <td class="px-4 py-3 text-slate-600 whitespace-nowrap">{{ row.endTime ? (row.endTime | date: uiDateFormat) : '—' }}</td>
                    <td class="px-4 py-3 text-center">
                      <input type="checkbox" class="h-4 w-4 rounded border-slate-300 text-onsemi-primary focus:ring-onsemi-primary/40"
                             [checked]="isRowSelected(row)" (change)="toggleRow(row, $event.target.checked)" />
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
            <p class="px-4 py-3 text-sm text-slate-500" *ngIf="!previewRows.length && !previewLoading">No results on this page.</p>
          </div>

          <div class="flex flex-col gap-3 rounded-2xl border border-slate-200 bg-slate-50 p-4 text-sm md:flex-row md:items-center md:justify-between">
            <div class="flex items-center gap-3">
              <button type="button" class="btn-secondary" (click)="changePreviewPage(-1)" [disabled]="previewLoading || previewPage === 0">Prev</button>
              <span>Page {{ previewPage + 1 }} of {{ previewLastPage + 1 }}</span>
              <button type="button" class="btn-secondary" (click)="changePreviewPage(1)" [disabled]="previewLoading || previewLastPage < 0 || previewPage >= previewLastPage">Next</button>
            </div>
            <div class="flex items-center gap-3">
              <label for="previewSize" class="text-sm text-slate-600">Page size</label>
              <select id="previewSize" [(ngModel)]="previewSize" name="previewSize" (ngModelChange)="changePreviewSize($event)"
                      class="rounded-lg border border-slate-300 bg-white px-3 py-2 text-sm shadow-sm focus:border-onsemi-primary focus:outline-none focus:ring-2 focus:ring-onsemi-primary/40">
                <option *ngFor="let size of previewSizes" [value]="size">{{ size }}</option>
              </select>
            </div>
          </div>

          <label class="flex items-center gap-2 text-sm text-slate-600">
            <input type="checkbox" class="h-4 w-4 rounded border-slate-300 text-onsemi-primary focus:ring-onsemi-primary/40" [(ngModel)]="triggerDispatch" name="triggerDispatch" />
            Dispatch immediately after staging
          </label>

          <div class="flex flex-col gap-3 sm:flex-row sm:items-center sm:justify-between">
            <button type="button" class="btn-secondary" (click)="goToStep(0)">Back</button>
            <p class="text-sm text-slate-600">{{ selectedCount }} selected</p>
            <button type="button" class="btn-primary" (click)="stageSelected()" [disabled]="staging || selectedCount === 0">
              <ng-container *ngIf="!staging; else stagingTpl">Stage selected</ng-container>
            </button>
            <ng-template #stagingTpl>
              <div class="flex items-center justify-center gap-2">
                <span class="h-4 w-4 animate-spin rounded-full border-2 border-white border-t-transparent"></span>
                Staging…
              </div>
            </ng-template>
          </div>
        </ng-container>
        <ng-template #noPreviewState>
          <div class="rounded-2xl border border-dashed border-slate-300 bg-slate-50 p-6 text-center text-sm text-slate-600">
            Preview results appear here after step 1.
          </div>
        </ng-template>
      </section>

      <section *ngSwitchCase="2" class="space-y-6">
        <div class="flex flex-col gap-3 sm:flex-row sm:items-center sm:justify-between">
          <button type="button" class="btn-secondary" (click)="reset()">Start over</button>
          <button type="button" class="btn-primary" (click)="refreshMonitoring()" [disabled]="statusLoading || stageRecordsLoading">
            <ng-container *ngIf="!(statusLoading || stageRecordsLoading); else refreshingTpl">Refresh metrics</ng-container>
          </button>
          <ng-template #refreshingTpl>
            <div class="flex items-center justify-center gap-2">
              <span class="h-4 w-4 animate-spin rounded-full border-2 border-white border-t-transparent"></span>
              Refreshing…
            </div>
          </ng-template>
        </div>

        <div *ngIf="stageResponse" class="space-y-4 rounded-2xl border border-onsemi-primary/20 bg-onsemi-ice/60 p-5">
          <div class="flex flex-wrap gap-6 text-sm text-onsemi-charcoal">
            <p><strong>Staged:</strong> {{ stageResponse.staged ?? 0 }}</p>
            <p><strong>Duplicates:</strong> {{ stageResponse.duplicates ?? 0 }}</p>
            <p><strong>Dispatched:</strong> {{ stageResponse.dispatched ?? 0 }}</p>
          </div>
          <div class="rounded-xl border border-amber-300 bg-amber-50 px-4 py-3 text-sm text-amber-700" *ngIf="stageResponse.requiresConfirmation">
            Dispatch pending confirmation. Re-run staging to proceed.
          </div>
          <div *ngIf="stageResponse.duplicatePayloads.length" class="space-y-3">
            <div class="flex items-center justify-between">
              <p class="text-sm font-semibold text-onsemi-charcoal">Duplicate payloads ({{ stageResponse.duplicatePayloads.length }})</p>
              <button type="button" class="btn-secondary" (click)="copyDuplicatesToClipboard()">Copy duplicates</button>
            </div>
            <div class="overflow-auto rounded-xl border border-slate-200 bg-white">
              <table class="min-w-full divide-y divide-slate-200 text-sm">
                <thead class="bg-onsemi-ice text-onsemi-charcoal">
                  <tr>
                    <th class="px-4 py-3 text-left font-semibold">Metadata</th>
                    <th class="px-4 py-3 text-left font-semibold">Data</th>
                    <th class="px-4 py-3 text-left font-semibold">Requested By</th>
                    <th class="px-4 py-3 text-left font-semibold">Last Requested</th>
                    <th class="px-4 py-3 text-left font-semibold">Status</th>
                  </tr>
                </thead>
                <tbody class="divide-y divide-slate-100">
                  <tr *ngFor="let dup of stageResponse.duplicatePayloads" class="bg-white">
                    <td class="px-4 py-3 font-medium text-onsemi-charcoal">{{ dup.metadataId }}</td>
                    <td class="px-4 py-3 text-slate-700">{{ dup.dataId }}</td>
                    <td class="px-4 py-3 text-slate-700">{{ dup.lastRequestedBy || dup.stagedBy || 'unknown' }}</td>
                    <td class="px-4 py-3 text-slate-600">{{ dup.lastRequestedAt ? (dup.lastRequestedAt | date: uiDateFormat) : '—' }}</td>
                    <td class="px-4 py-3 text-slate-600">{{ dup.previousStatus || '—' }}</td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>

        <div *ngIf="stageStatus.length" class="grid gap-4 md:grid-cols-2 xl:grid-cols-3">
          <div *ngFor="let status of stageStatus" class="rounded-2xl border border-slate-200 bg-white p-5 shadow-sm">
            <h3 class="text-sm font-semibold text-onsemi-charcoal">Sender {{ status.senderId }}</h3>
            <dl class="mt-3 space-y-2 text-sm text-slate-600">
              <div class="flex justify-between"><dt>Total</dt><dd class="font-semibold text-onsemi-charcoal">{{ status.total }}</dd></div>
              <div class="flex justify-between"><dt>Ready</dt><dd class="font-semibold text-onsemi-charcoal">{{ status.ready }}</dd></div>
              <div class="flex justify-between"><dt>Enqueued</dt><dd class="font-semibold text-onsemi-charcoal">{{ status.enqueued }}</dd></div>
              <div class="flex justify-between"><dt>Completed</dt><dd class="font-semibold text-onsemi-charcoal">{{ status.completed }}</dd></div>
              <div class="flex justify-between"><dt>Failed</dt><dd class="font-semibold text-onsemi-charcoal">{{ status.failed }}</dd></div>
            </dl>
            <div class="mt-4 space-y-2" *ngIf="status.users.length">
              <p class="text-xs font-semibold uppercase tracking-wide text-slate-500">User breakdown</p>
              <div class="space-y-2 text-xs text-slate-600">
                <div *ngFor="let user of status.users" class="rounded-xl border border-slate-200 bg-slate-50 p-3">
                  <div class="flex items-center justify-between">
                    <span class="font-semibold text-onsemi-charcoal">{{ user.username || 'unknown' }}</span>
                    <span class="text-slate-500">{{ user.lastRequestedAt ? (user.lastRequestedAt | date: uiDateFormat) : '—' }}</span>
                  </div>
                  <div class="mt-2 flex flex-wrap gap-2">
                    <span class="rounded-full bg-green-100 px-2 py-1 text-[11px] font-semibold text-green-700">R {{ user.ready }}</span>
                    <span class="rounded-full bg-blue-100 px-2 py-1 text-[11px] font-semibold text-blue-700">E {{ user.enqueued }}</span>
                    <span class="rounded-full bg-red-100 px-2 py-1 text-[11px] font-semibold text-red-700">F {{ user.failed }}</span>
                    <span class="rounded-full bg-slate-200 px-2 py-1 text-[11px] font-semibold text-slate-700">C {{ user.completed }}</span>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
        <p *ngIf="!stageStatus.length && !statusLoading" class="text-sm text-slate-600">No staging metrics available yet.</p>

        <div class="flex flex-col gap-4 rounded-2xl border border-slate-200 bg-slate-50 p-4 md:flex-row md:items-center md:justify-between">
          <div class="flex items-center gap-3">
            <label for="recordStatus" class="text-sm text-slate-600">Status filter</label>
            <select id="recordStatus" [(ngModel)]="stageRecordsStatus" name="recordsStatus" (ngModelChange)="loadStageRecords(0)"
                    class="rounded-lg border border-slate-300 bg-white px-3 py-2 text-sm shadow-sm focus:border-onsemi-primary focus:outline-none focus:ring-2 focus:ring-onsemi-primary/40">
              <option value="ALL">All</option>
              <option value="NEW">New</option>
              <option value="ENQUEUED">Enqueued</option>
              <option value="DONE">Done</option>
              <option value="FAILED">Failed</option>
            </select>
          </div>
          <div class="flex items-center gap-3">
            <label for="recordPageSize" class="text-sm text-slate-600">Page size</label>
            <select id="recordPageSize" [(ngModel)]="stageRecordsSize" name="recordPageSize" (ngModelChange)="changeStageRecordsSize($event)"
                    class="rounded-lg border border-slate-300 bg-white px-3 py-2 text-sm shadow-sm focus:border-onsemi-primary focus:outline-none focus:ring-2 focus:ring-onsemi-primary/40">
              <option *ngFor="let size of stageRecordsSizes" [value]="size">{{ size }}</option>
            </select>
          </div>
        </div>

        <div class="relative overflow-hidden rounded-2xl border border-slate-200">
          <div *ngIf="stageRecordsLoading" class="absolute inset-0 z-10 flex items-center justify-center bg-white/70">
            <span class="h-6 w-6 animate-spin rounded-full border-2 border-onsemi-primary border-t-transparent"></span>
          </div>
          <div class="overflow-auto">
            <table class="min-w-full divide-y divide-slate-200 text-sm">
              <thead class="bg-onsemi-ice text-onsemi-charcoal">
                <tr>
                  <th class="px-4 py-3 text-left font-semibold">Metadata ID</th>
                  <th class="px-4 py-3 text-left font-semibold">Data ID</th>
                  <th class="px-4 py-3 text-left font-semibold">Status</th>
                  <th class="px-4 py-3 text-left font-semibold">Staged By</th>
                  <th class="px-4 py-3 text-left font-semibold">Last Requested</th>
                  <th class="px-4 py-3 text-left font-semibold">Updated</th>
                  <th class="px-4 py-3 text-left font-semibold">Error</th>
                </tr>
              </thead>
              <tbody class="divide-y divide-slate-100 bg-white">
                <tr *ngFor="let record of stageRecords" class="hover:bg-onsemi-ice/60">
                  <td class="px-4 py-3 font-medium text-onsemi-charcoal">{{ record.metadataId || '—' }}</td>
                  <td class="px-4 py-3 text-slate-700">{{ record.dataId || '—' }}</td>
                  <td class="px-4 py-3 text-slate-700">{{ record.status }}</td>
                  <td class="px-4 py-3 text-slate-700">{{ record.lastRequestedBy || record.stagedBy || 'unknown' }}</td>
                  <td class="px-4 py-3 text-slate-600">{{ record.lastRequestedAt ? (record.lastRequestedAt | date: uiDateFormat) : '—' }}</td>
                  <td class="px-4 py-3 text-slate-600">{{ record.updatedAt | date: uiDateFormat }}</td>
                  <td class="px-4 py-3 text-slate-600">{{ record.errorMessage || '—' }}</td>
                </tr>
              </tbody>
            </table>
          </div>
          <p class="px-4 py-3 text-sm text-slate-500" *ngIf="!stageRecords.length && !stageRecordsLoading">No staged records for this filter.</p>
        </div>

        <div class="flex items-center justify-between rounded-2xl border border-slate-200 bg-slate-50 p-4 text-sm text-slate-600" *ngIf="stageRecordsTotal > 0">
          <button type="button" class="btn-secondary" (click)="changeStageRecordsPage(-1)" [disabled]="stageRecordsLoading || stageRecordsPage === 0">Prev</button>
          <span>Page {{ stageRecordsPage + 1 }} of {{ stageRecordsLastPage + 1 }}</span>
          <button type="button" class="btn-secondary" (click)="changeStageRecordsPage(1)" [disabled]="stageRecordsLoading || stageRecordsLastPage < 0 || stageRecordsPage >= stageRecordsLastPage">Next</button>
        </div>
      </section>
    </ng-container>
  </div>
</section>
