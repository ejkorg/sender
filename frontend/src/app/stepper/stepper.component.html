<mat-card class="stepper-card">
  <mat-horizontal-stepper linear [selectedIndex]="stepIndex" (selectionChange)="stepIndex = $event.selectedIndex">
    <mat-step label="1. Select filters" [completed]="stepIndex > 0">
      <div class="step-content">
        <mat-form-field appearance="fill" class="full-width">
          <mat-label>Site / Connection</mat-label>
          <mat-select [(ngModel)]="selectedSite" name="site" (selectionChange)="onSiteChange()">
            <mat-option [value]="null">-- Select site --</mat-option>
            <mat-option *ngFor="let s of sites" [value]="s">{{ s }}</mat-option>
          </mat-select>
        </mat-form-field>

        <div class="filters-loading" *ngIf="filtersLoading">
          <mat-progress-spinner diameter="24" mode="indeterminate"></mat-progress-spinner>
          <span>Loading connection filters…</span>
        </div>

        <ng-container *ngIf="!filtersLoading && filterOptions as filters">
          <div class="two-col">
            <mat-form-field appearance="fill">
              <mat-label>Location</mat-label>
              <mat-select [(ngModel)]="selectedLocation" name="location">
                <mat-option [value]="''">-- Select location --</mat-option>
                <mat-option *ngFor="let loc of filters.locations" [value]="loc">{{ loc }}</mat-option>
              </mat-select>
            </mat-form-field>

            <mat-form-field appearance="fill">
              <mat-label>Data type</mat-label>
              <mat-select [(ngModel)]="selectedDataType" name="dataType">
                <mat-option [value]="''">-- Any --</mat-option>
                <mat-option *ngFor="let dt of filters.dataTypes" [value]="dt">{{ dt }}</mat-option>
              </mat-select>
            </mat-form-field>
          </div>

          <div class="two-col">
            <mat-form-field appearance="fill">
              <mat-label>Tester type</mat-label>
              <mat-select [(ngModel)]="selectedTesterType" name="testerType">
                <mat-option [value]="''">-- Any --</mat-option>
                <mat-option *ngFor="let tt of filters.testerTypes" [value]="tt">{{ tt }}</mat-option>
              </mat-select>
            </mat-form-field>

            <mat-form-field appearance="fill">
              <mat-label>Phase / Data type ext</mat-label>
              <mat-select [(ngModel)]="selectedTestPhase" name="testPhase">
                <mat-option [value]="''">-- Any --</mat-option>
                <mat-option *ngFor="let phase of filters.dataTypeExt || []" [value]="phase">{{ phase || 'None' }}</mat-option>
              </mat-select>
            </mat-form-field>
          </div>

          <mat-form-field appearance="fill" class="full-width" *ngIf="filters.fileTypes?.length">
            <mat-label>File type</mat-label>
            <mat-select [(ngModel)]="selectedFileType" name="fileType">
              <mat-option [value]="''">-- Any --</mat-option>
              <mat-option *ngFor="let ft of filters.fileTypes" [value]="ft">{{ ft }}</mat-option>
            </mat-select>
          </mat-form-field>
        </ng-container>

        <div class="two-col">
          <div class="date-range">
            <mat-form-field appearance="fill">
              <mat-label>Start date</mat-label>
              <input matInput [matDatepicker]="startPicker" [(ngModel)]="startDate" name="startDate" />
              <mat-datepicker-toggle matSuffix [for]="startPicker"></mat-datepicker-toggle>
              <mat-datepicker #startPicker></mat-datepicker>
            </mat-form-field>
            <mat-form-field appearance="fill">
              <mat-label>End date</mat-label>
              <input matInput [matDatepicker]="endPicker" [(ngModel)]="endDate" name="endDate" />
              <mat-datepicker-toggle matSuffix [for]="endPicker"></mat-datepicker-toggle>
              <mat-datepicker #endPicker></mat-datepicker>
            </mat-form-field>
          </div>
        </div>

        <div class="step-actions">
          <span class="helper" *ngIf="!canSearch()">Select a site and location to continue.</span>
          <button mat-flat-button color="primary" (click)="doSearch()" [disabled]="loading || !canSearch()">
            <mat-icon *ngIf="loading" class="spinner-icon">sync</mat-icon>
            {{ loading ? 'Searching…' : 'Search' }}
          </button>
        </div>
      </div>
    </mat-step>

    <mat-step label="2. Review and resend" [completed]="stepIndex > 1">
      <div class="step-content">
        <ng-container *ngIf="discovered.length; else noResults">
          <p class="summary">{{ discovered.length }} result{{ discovered.length === 1 ? '' : 's' }} found. Uncheck anything you do not want to resend.</p>

          <mat-form-field appearance="fill" class="full-width" *ngIf="senders.length">
            <mat-label>Sender to enqueue</mat-label>
            <mat-select [(ngModel)]="selectedSenderId" name="selectedSenderId">
              <mat-option *ngFor="let s of senders" [value]="s.idSender">{{ s.idSender }} — {{ s.name }}</mat-option>
            </mat-select>
          </mat-form-field>

          <mat-selection-list [(ngModel)]="selectedDiscovered" [multiple]="true">
            <mat-list-option *ngFor="let item of discovered" [value]="item">
              <div class="result-line">
                <div class="title">{{ item.idSender || 'unknown' }} — {{ item.name || item.payloadId }}</div>
                <div class="meta" *ngIf="item.metadataLocation || item.location">{{ item.metadataLocation || item.location }}</div>
              </div>
            </mat-list-option>
          </mat-selection-list>

          <div class="step-actions">
            <button mat-button type="button" (click)="goToStep(0)">Back</button>
            <button mat-raised-button color="primary" type="button" (click)="enqueueSelected()">Resend selected</button>
          </div>
        </ng-container>
        <ng-template #noResults>
          <p *ngIf="!loading">No results yet — run a search in step 1.</p>
        </ng-template>
      </div>
    </mat-step>

    <mat-step label="3. Monitor status">
      <div class="step-content">
        <div class="step-actions">
          <button mat-button type="button" (click)="reset()">Start over</button>
        </div>

        <mat-card *ngIf="enqueueResponse" class="enqueue-card">
          <mat-card-title>Latest enqueue</mat-card-title>
          <mat-card-content>
            <div><strong>Enqueued:</strong> {{ enqueueResponse.enqueued ?? '?' }}</div>
            <div *ngIf="enqueueResponse.skipped?.length">
              <p><strong>Skipped ({{ enqueueResponse.skipped?.length ?? 0 }}):</strong></p>
              <mat-list>
                <mat-list-item *ngFor="let id of enqueueResponse.skipped">{{ id }}</mat-list-item>
              </mat-list>
              <button mat-button type="button" (click)="copySkippedToClipboard()">Copy skipped IDs</button>
            </div>
            <div *ngIf="!enqueueResponse.skipped?.length"><small>No skipped items reported.</small></div>
          </mat-card-content>
        </mat-card>

        <div *ngIf="monitoringQueue.length; else emptyQueue">
          <mat-card *ngFor="let entry of monitoringQueue" class="queue-entry">
            <mat-card-content class="queue-row">
              <div>
                <div class="title">{{ entry.payloadId || entry.id_data || entry.id_metadata }}</div>
                <div class="meta">{{ entry.createdAt | date:'short' }}</div>
              </div>
              <mat-chip [color]="getStatusColor(entry.status)" selected>{{ entry.status }}</mat-chip>
            </mat-card-content>
          </mat-card>
        </div>
        <ng-template #emptyQueue>
          <p>No queue items found yet.</p>
        </ng-template>
      </div>
    </mat-step>
  </mat-horizontal-stepper>
</mat-card>
