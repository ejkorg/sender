<?xml version="1.0" encoding="UTF-8"?>
<databaseChangeLog
        xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
        xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
        xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
            http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.1.xsd">

    <changeSet id="2025-10-04-1-dedupe-load-session-payload" author="copilot">
        <preConditions onFail="MARK_RAN">
            <tableExists tableName="load_session_payload" />
        </preConditions>
        <!-- Delete duplicate rows keeping the lowest id for each (session_id, payload_id) -->
        <comment>Dedupe existing load_session_payload rows keeping lowest id per (session_id, payload_id)</comment>
        <sql>
            -- H2/Generic SQL: delete rows where id is not the min id for that session/payload
            DELETE FROM load_session_payload WHERE id NOT IN (
                SELECT MIN(id) FROM load_session_payload GROUP BY session_id, payload_id
            );
        </sql>
    </changeSet>

    <changeSet id="2025-10-04-2-add-global-payload-id" author="copilot">
        <preConditions onFail="MARK_RAN">
            <tableExists tableName="load_session_payload" />
        </preConditions>
        <addColumn tableName="load_session_payload">
            <column name="global_payload_id" type="BIGINT" />
        </addColumn>
    </changeSet>

    <changeSet id="2025-10-04-3-add-unique-constraint-session-payload" author="copilot">
        <preConditions onFail="MARK_RAN">
            <and>
                <tableExists tableName="load_session_payload" />
            </and>
        </preConditions>
        <addUniqueConstraint tableName="load_session_payload" columnNames="session_id, payload_id" constraintName="uk_load_session_payload_session_payload"/>
    </changeSet>

</databaseChangeLog>
