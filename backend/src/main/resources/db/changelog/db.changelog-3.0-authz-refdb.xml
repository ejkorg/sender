<?xml version="1.0" encoding="UTF-8"?>
<databaseChangeLog
        xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
        xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
        xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
            http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.8.xsd">

    <!-- RefDB local authorization schema: users, roles, user_roles -->

    <changeSet id="2025-10-17-1-create-app-users" author="copilot">
        <preConditions onFail="MARK_RAN" onError="HALT">
            <not>
                <tableExists tableName="APP_USERS"/>
            </not>
        </preConditions>
        <createTable tableName="APP_USERS">
            <column name="username" type="VARCHAR(128)">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="active" type="BOOLEAN">
                <constraints nullable="false"/>
            </column>
        </createTable>
        <!-- Oracle boolean compatibility: migrate column type to NUMBER(1) when dbms=oracle -->
        <modifyDataType tableName="APP_USERS" columnName="active" newDataType="NUMBER(1)" dbms="oracle"/>
        <!-- Default active=1 for Oracle; true for others -->
        <addDefaultValue tableName="APP_USERS" columnName="active" defaultValueBoolean="true"/>
    </changeSet>

    <changeSet id="2025-10-17-2-create-app-roles" author="copilot">
        <preConditions onFail="MARK_RAN" onError="HALT">
            <not>
                <tableExists tableName="APP_ROLES"/>
            </not>
        </preConditions>
        <createTable tableName="APP_ROLES">
            <column name="name" type="VARCHAR(64)">
                <constraints primaryKey="true" nullable="false"/>
            </column>
        </createTable>
    </changeSet>

    <changeSet id="2025-10-17-3-create-app-user-roles" author="copilot">
        <preConditions onFail="MARK_RAN" onError="HALT">
            <not>
                <tableExists tableName="APP_USER_ROLES"/>
            </not>
        </preConditions>
        <createTable tableName="APP_USER_ROLES">
            <column name="username" type="VARCHAR(128)">
                <constraints nullable="false"/>
            </column>
            <column name="role_name" type="VARCHAR(64)">
                <constraints nullable="false"/>
            </column>
        </createTable>
        <addPrimaryKey tableName="APP_USER_ROLES" columnNames="username, role_name" constraintName="PK_APP_USER_ROLES"/>
    </changeSet>

    <changeSet id="2025-10-17-4-seed-baseline-roles" author="copilot">
        <preConditions onFail="MARK_RAN" onError="HALT">
            <and>
                <tableExists tableName="APP_ROLES"/>
                <sqlCheck expectedResult="0">SELECT COUNT(*) FROM APP_ROLES WHERE name = 'ROLE_USER'</sqlCheck>
            </and>
        </preConditions>
        <insert tableName="APP_ROLES">
            <column name="name" value="ROLE_USER"/>
        </insert>
    </changeSet>

    <changeSet id="2025-10-17-5-seed-admin-role" author="copilot">
        <preConditions onFail="MARK_RAN" onError="HALT">
            <and>
                <tableExists tableName="APP_ROLES"/>
                <sqlCheck expectedResult="0">SELECT COUNT(*) FROM APP_ROLES WHERE name = 'ROLE_ADMIN'</sqlCheck>
            </and>
        </preConditions>
        <insert tableName="APP_ROLES">
            <column name="name" value="ROLE_ADMIN"/>
        </insert>
    </changeSet>

</databaseChangeLog>